<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta codeset="ASCII">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<link id="currentTheme" href="bootstrap/css/_cyborg_bootstrap.min.css" rel="stylesheet">
		<link href="style.css" rel="stylesheet">
		<script src="jquery-1.10.2.min.js"></script>
		<script src="/socket.io/socket.io.js"></script>
		<script src="bootstrap/js/bootstrap.min.js"></script>
		<script src="ionsound/ion.sound.js"></script>
		<script>
			$(document).ready(function(){

				ion.sound({
					sounds: [
						{name: "water_droplet"},
						{name: "webAlert_2"}
					],
					path: "sounds/",
					preload: true,
					volume: 1.0
				});


			});
			/*var maxIndex = 5;
			var currentIndex = 0;
			var themes = [
			"bootstrap/css/_default_bootstrap.min.css",
			"bootstrap/css/_cyborg_bootstrap.min.css",
			"bootstrap/css/_darkly_bootstrap.min.css",
			"bootstrap/css/_slate_bootstrap.min.css",
			"bootstrap/css/_superhero_bootstrap.min.css",
			"bootstrap/css/_ubuntu_bootstrap.min.css",
			];
			function switchColorTheme(){
				if(currentIndex>=5){
					currentIndex=0;
				}
				else{
					currentIndex++;
				}
				$("#currentTheme").attr("href",themes[currentIndex]);
			}*/
		</script>
		<title>Ввод пароля</title>

	</head>
	<body>
		<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		  <div class="modal-dialog">
			<div class="modal-content">
			  <div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title text-center" id="myModalLabel">Внимание!</h4>
			  </div>
			  <div class="modal-body">
				...
			  </div>
			  <div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">Закрыть</button>
			  </div>
			</div>
		  </div>
		</div>
    
		<div id='waitDoor' class="container" style="display:none;">
			<div class="row text-center">
				<div class="col-xs-12">
					<h1 class="qqq-h1"><mark id='doorCloseTimeLeft'></mark> секунд до включения сигнализации</h1>
				</div>
				<div class="col-xs-12">
					<h1 class="qqq-h1">Состояние двери:</h1>
					<h1 class="qqq-h1"><mark id='doorState1'>Неизвестно</mark></h1>
					<img id="doorOpenIcon1" src="img/openDoor.png" style="display:none; height:10em;"/>
					<img id="doorCloseIcon1" src="img/closedDoor.png" style="display:none; height:10em;"/>
				</div>
				<div class="col-xs-6">
					<button onclick='alarmEnablingCancel()' class="btn btn-default btn-lg btn-block btn-danger qqq-btn" >Отмена</button>
				</div>
				<div class="col-xs-6">
					<button id="alarmEnablingForcedButton" onclick='alarmEnablingForced()' class="btn btn-default btn-lg btn-block btn-success qqq-btn" >Включить сейчас</button>
				</div>
			</div>
		</div>
		
		<div id="mainScreen" class="container" style="display:none;">
			<div class="row">
				<div class="col-xs-12">
					<div class="panel panel-default" style="margin-bottom:0;">
						<div class="panel-heading">
						
							<div style="overflow:hidden;">
							</div>
							<div class="row">
								<div class="col-xs-10">
									<h1 class="qqq-h1 qqq-margin0" style="margin:10px 0;" >Объект: <span id="objectName">Неизвестно</span></h1>
									<h1 class="qqq-h1 qqq-margin0" style="margin:10px 0; display:none;" id="userNameWrap">Пользователь: <span id="userName">Неизвестно</span></h1>
								</div>
								<div class="col-xs-2 text-right">
									<img src="img/logo.png" style="height:7em; margin-bottom: 10px;"/>
								</div>
							</div>
						</div>
						<div id="panelBody1" class="panel-body" style="padding:1em;">
						
							<div class="row">
								<div class="col-xs-6">
									<button id='btnAlarmOff' onclick='manualOff()'  class="btn btn-default btn-lg btn-block btn-danger qqq-btn" type="submit">
										<p class="" style="margin:0;">Отключить сигнализацию</p>
									</button>
									<button id='btnAlarmOn' onclick="turnOn2()"  class="btn btn-default btn-lg btn-block btn-success qqq-btn" type="submit">
										<p class="" style="margin:0;">Включить сигнализацию</p>
									</button>
								</div>
								<div class="col-xs-6">
									<button id='showDetails' onclick="showDetails()"  class="btn btn-default btn-lg btn-block btn-info qqq-btn" type="submit">
										<p class="" style="margin:0;">Подробнее</p>
									</button>
								</div>
							</div>
							
							
							<div class="row qqq-row text-center">
								<div class="col-xs-6 qqq-row-left">
									<h1 class="qqq-h1">Состояние двери:</h1>
									<h1 class="qqq-h1"><mark id='doorState'>Неизвестно</mark></h1>
									<img id="doorOpenIcon" src="img/openDoor.png" style="display:none; height:10em;"/>
									<img id="doorCloseIcon" src="img/closedDoor.png" style="display:none; height:10em;"/>
								</div>
								<div class="col-xs-6 qqq-row-right">
									<h1 class="qqq-h1">Состояние сигнализации:</h1>
									<h1 class="qqq-h1"><mark id='alarmState'>Неизвестно</mark></h1>
									<img id="alarmOnIcon" src="img/alarmOn.png" style="display:none; height:10em;"/>
									<img id="alarmOffIcon" src="img/alarmOff.png" style="display:none; height:10em;"/>
								</div>
							</div>
							<div class="row">
								<div class="col-xs-12">
									<h1 class="" style="display:none;">Состояние ввода: <mark id='isWaitingForInput'></mark></h1>
								</div>
								<div class="col-xs-12">
									<h1 class="" style="display:none;">Ожидание закрытия двери: <mark id='doorWaiting'></mark></h1>
								</div>
								<div class="col-xs-12">
									<h1 class="" style="display:none;">Времени до закрытия двери: <mark id='doorCloseTimeLeft'></mark></h1>
								</div>
							</div>
							
							<div class="row">
								<div class="col-xs-12">&nbsp;</div>
							</div>
							
							
						</div>
						
						<div id="panelBody2" class="panel-body" style="padding:1em; display:none;">
							<div class="row">
								<div class="col-xs-12">&nbsp;</div>
							</div>
							<div class="row">
								<div class="col-xs-12">
									<h1>Страница находится на этапе разработки</h1>
								</div>
								<div class="col-xs-3">
								</div>
								<div class="col-xs-6">
									<button onclick="hideDetails()" class="btn btn-default btn-lg btn-block qqq-btn btn-info" >Вернуться назад</button>
								</div>
								<div class="col-xs-6">
								</div>
							</div>
							<div class="row">
								<div class="col-xs-12">&nbsp;</div>
							</div>
						</div>
						
					</div>
				</div>
			</div>
		</div>
		
		<script>
		
			var isTurnOn = false;
		
			function turnOn2(){
				showingPinEnter = true;
				isTurnOn = true;
			}
		
			function showDetails(){
				$("#panelBody1").hide();
				$("#panelBody2").show();
			}
			function hideDetails(){
				$("#panelBody1").show();
				$("#panelBody2").hide();
			}

			var isAlarmSoundOn = false;
			var socket = io();
			var manualTurnOff = false;
			function turnOff() {
				socket.emit('pin', $('#pin').html());
				$('#pin').html("");
			}

			function alarmEnablingCancel(){
				socket.emit('alarmEnablingCancel', 123);
			}
			function alarmEnablingForced(){
				socket.emit('alarmEnablingForced', 123);
			}
			
			showingPinEnter = false;

			function manualOff() {
				manualTurnOff = true;
			}
			
			function manualOffCancel(){
				manualTurnOff = false;
				showingPinEnter = false;
				isTurnOn = false;
			}

			function turnOn() {
				socket.emit('alarmOn', $('#pin').html());
				showingPinEnter = false;
				isTurnOn = false;
				$('#pin').html("");
			}
			
			socket.on('pinerror', function(){
				$('#myModal').find('.modal-body').html("<h1 class='qqq-h1 text-center'>Неверный пинкод</h1>");
				$('#myModal').modal('show');
			});
			
			socket.on('unableToSetSignal', function(){
				$('#myModal').find('.modal-body').html("<h1 class='qqq-h1 text-center'>Невозможно установить сигнализацию</h1><h1 class='qqq-h1 text-center'>Закройте дверь!</h1>");
				$('#myModal').modal('show');
			});

			socket.on('time', function (data) {
				$("#objectName").html(data.objectName);

				if (data.isWaitingForInput || manualTurnOff || isTurnOn) {
					if (!showingPinEnter) {
						if(!isTurnOn){
							$('#pin').html('');
						}
						$('#mainScreen').hide();
						$('#pinEnter').show();
						$('#waitDoor').hide();
						showingPinEnter = true;
						console.log("1data.doorState - "+data.doorState);
						console.log("2isAlarmSoundOn - "+isAlarmSoundOn);
						if(!data.doorState & !isAlarmSoundOn){
							console.log("3 - inside if");
							ion.sound.play("webAlert_2", {
								loop: true
							});
							isAlarmSoundOn = true;
						}
					}
				} else {
					ion.sound.stop("webAlert_2");
					isAlarmSoundOn = false;
					$('#pinEnter').hide();
					$('#mainScreen').show();
					$('#waitDoor').hide();
					showingPinEnter = false;
				}

				$('#leftSeconds').html(data.timeLeft);
				if (!data.doorState) {
					$('#doorState').html('Открыта');
					$('#doorState').addClass("stateWarning");
					$('#doorState').removeClass("stateOk");
					$('#doorState1').html('Открыта');
					$('#doorState1').addClass("stateWarning");
					$('#doorState1').removeClass("stateOk");
					$("#doorOpenIcon").show();
					$("#doorCloseIcon").hide();
					$("#doorOpenIcon1").show();
					$("#doorCloseIcon1").hide();
					$('#alarmEnablingForcedButton').attr("disabled","disabled");
				} else {
					$('#doorState').html('Закрыта');
					$('#doorState').removeClass("stateWarning");
					$('#doorState').addClass("stateOk");
					$('#doorState1').html('Закрыта');
					$('#doorState1').removeClass("stateWarning");
					$('#doorState1').addClass("stateOk");
					$("#doorOpenIcon").hide();
					$("#doorCloseIcon").show();
					$("#doorOpenIcon1").hide();
					$("#doorCloseIcon1").show();
					$('#alarmEnablingForcedButton').removeAttr("disabled","disabled");
				}

				if (data.alarmState) {
					$('#btnAlarmOff').show();
					$('#btnAlarmOn').hide();
					$('#alarmState').removeClass("stateWarning");
					$('#alarmState').addClass("stateOk");
					$('#alarmState').html('Установлена');
					$("#alarmOnIcon").show();
					$("#alarmOffIcon").hide();
					$("#userNameWrap").hide();
				} else {
					$('#btnAlarmOn').show();
					$("#btnAlarmOff").hide();
					$('#alarmState').addClass("stateWarning");
					$('#alarmState').removeClass("stateOk");
					$('#alarmState').html('Снято');
					$("#alarmOnIcon").hide();
					$("#alarmOffIcon").show();
					manualTurnOff = false;
					showingPinEnter = false;
				}
				if(data.isWaitingForInput){
					$("#isWaitingCountdown").show();
					$("#enterPincodeTitle").hide();
				}
				else{
					$("#isWaitingCountdown").hide();
					$("#enterPincodeTitle").show();
				}
				$('#isWaitingForInput').html(data.isWaitingForInput);
				if (data.doorWaiting) {
					$('#waitDoor').show();
					$('#mainScreen').hide();
					$('#pinEnter').hide();
				}
				$('#doorWaiting').html(data.doorWaiting);
				$('#doorCloseTimeLeft').html(data.doorCloseTime);
			});
			
			socket.on('userName', function(data){
				$("#userName").html(data);
				$("#userNameWrap").show();
			});

			socket.on('doorState', function (data) {
				$('#doorState').html(data);
			});

			socket.on('alarmState', function (data) {
				$('#alarmState').html(data);
			});
		</script>
		
		<div id='pinEnter' class="container" style="display:none;">
			<div class="row">
				<div class="col-xs-12">&nbsp;</div>
			</div>
			<div class="row">
				<div class="col-xs-12">&nbsp;</div>
			</div>
			<div id="isWaitingCountdown" class="row" style="display:none;">
				<div class="col-xs-12">
					<h1 class="qqq-h1 text-danger pull-left">Дверь была открыта, введите пинкод. Осталось: </h1>
					<h1 id="leftSeconds" class="qqq-h1 text-danger pull-left">60</h1>
					<h1 class="qqq-h1 text-danger pull-left">&nbsp;сек.</h1>
				</div>
			</div>
			<div id="enterPincodeTitle" class="row">
				<div class="col-xs-12">
					<h1 class="qqq-h1 text-danger text-center">Введите пинкод </h1>
				</div>
			</div>
			<div class="row">
				<div class="col-xs-12">&nbsp;</div>
			</div>
			<div class="row">
				<div class="col-xs-4" ><button class="key btn btn-default btn-lg btn-block qqq-btn" >1</button></div>
				<div class="col-xs-4" ><button class="key btn btn-default btn-lg btn-block qqq-btn" >2</button></div>
				<div class="col-xs-4" ><button class="key btn btn-default btn-lg btn-block qqq-btn" >3</button></div>
			</div>
			<div class="row">
				<div class="col-xs-12">&nbsp;</div>
			</div>
			<div class="row">
				<div class="col-xs-4" ><button class="key btn btn-default btn-lg btn-block qqq-btn" >4</button></div>
				<div class="col-xs-4" ><button class="key btn btn-default btn-lg btn-block qqq-btn" >5</button></div>
				<div class="col-xs-4" ><button class="key btn btn-default btn-lg btn-block qqq-btn" >6</button></div>
			</div>
			<div class="row">
				<div class="col-xs-12">&nbsp;</div>
			</div>
			<div class="row">
				<div class="col-xs-4" ><button class="key btn btn-default btn-lg btn-block qqq-btn" >7</button></div>
				<div class="col-xs-4" ><button class="key btn btn-default btn-lg btn-block qqq-btn" >8</button></div>
				<div class="col-xs-4" ><button class="key btn btn-default btn-lg btn-block qqq-btn" >9</button></div>
			</div>
			<div class="row">
				<div class="col-xs-12">&nbsp;</div>
			</div>
			<div class="row">
				<div class="col-xs-4" ><button class="key btn btn-default btn-lg btn-block btn-info qqq-btn">Очистить</button></div>
				<div class="col-xs-4" ><button class="key btn btn-default btn-lg btn-block qqq-btn" >0</button></div>
				<div class="col-xs-4" ><button class="key btn btn-default btn-lg btn-block btn-info qqq-btn" >Удалить</button></div>
			</div>
			<div class="row">
				<div class="col-xs-12">&nbsp;</div>
			</div>
			<div class="row">
				<div class="col-xs-4" ><button class="key btn btn-default btn-lg btn-block btn-warning qqq-btn" >Отмена</button></div>
				
				<div class="col-xs-4">
					<div class="well qqq-well">
						<div class="row">
							<div class="col-xs-12">
								<h1 id='pin' class="qqq-h1 text-muted qqq-margin0" style="overflow:hidden;height: 1em;text-align: center;"></h1>
							</div>
						</div>
					</div>
				</div>
				<div class="col-xs-4" ><button class="key btn btn-default btn-lg btn-block btn-success qqq-btn" >Ok</button></div>
				
			</div>
			
		</div>
		
		<script>
			
			
		
			$('.key').on("touchstart", function () {
				button_clicked($(this).html());
				ion.sound.play("water_droplet");
			});
			$('.key').on("click", function () {
				var isAndroid = navigator.userAgent.toLowerCase().indexOf("android");
				if(isAndroid == -1){
					button_clicked($(this).html());
					ion.sound.play("water_droplet");
				}
			});
			
			function button_clicked(code) {
				code = code.trim();
				//alert(code);
				if (code == "Ok") {
					if(!isTurnOn){
						turnOff();
					}
					else{
						turnOn();
					}
					return;
				}
				if (code == "Очистить") {
					$('#pin').html('');
					return;
				}
				if (code == "Отмена") {
					manualOffCancel();
					$('#pin').html('');
					return;
				}
				if (code == "Удалить") {
					var pincde = $('#pin').html();
					pincde = pincde.slice(0,-1);
					$('#pin').html(pincde);
					return;
				}
				$('#pin').append(code);
			}
		</script>
</body>
</html>